-----------------------------------------------------
Static Web Server https://localhost
Rest Server Angular http://localhost:50000
Charging Station Server http://localhost:58000
Database Server http://localhost:55000

-----------------------------------------------------
Prerequisites
-----------------------------------------------------
NodeJs 8.10.0
MongoDB 3.6
Npm 5.8.0sudo apt-get install -y mongodb-org
-----------------------------------------------------

-----------------------------------------------------
Script to show All Server logs
-----------------------------------------------------
NGINX
	- sudo tail -f /var/log/nginx/access.log
	- sudo tail -f /var/log/nginx/error.log

MONGO
	- sudo tail -f /var/log/mongodb/mongod.log

PM2
	- sudo tail -f /home/serge/.pm2/logs/start-error-0.log
	- sudo tail -f /home/serge/.pm2/logs/start-out-0.log

-----------------------------------------------------
Procedure to update the Site
-----------------------------------------------------
	- Compile in production mode Angular & Nodejs
	- Copy Angular 5 Dashboard to /var/www/html/evse
	- Copy NodeJS to /var/www/nodejs/evse/dist
	- Change file access if needed:
		sudo chmod +x * -R
	- Restart NGINX:
		sudo service nginx restart

-----------------------------------------------------
Procedure to restart the services
-----------------------------------------------------
	sudo service nginx restart
	pm2 restart 0
	sudo service mongod restart

-----------------------------------------------------
Topology
-----------------------------------------------------
NGINX		Path			Type 						Forwarded		Dest				Folder
HTTP 443 	/				Angular static files		No				static dir			/var/www/html/evse
HTTP 443	/client/api		Front-End Rest				Yes				localhost:50000		/var/www/nodejs/evse
HTTP 8000	/				Charging Stations OCPP		Yes				localhost:58000		/var/www/nodejs/evse
32500		/				Mongo DB					n/a				n/a					/var/lib/mongo

-----------------------------------------------------
SSL
-----------------------------------------------------
"ssl-key": "ssl/82.165.163.132.key",
"ssl-cert": "ssl/82.165.163.132.cer",
"ssl-ca": [ "ssl/82.165.163.132.inter.cer" ],

-----------------------------------------------------
NGINX
-----------------------------------------------------
sudo ps -aux | grep nginx
	Logs
		sudo tail -f /var/log/nginx/access.log
		sudo tail -f /var/log/nginx/error.log
	Edit Config
		sudo gedit /etc/nginx/nginx.conf
	SSL key
		/etc/pki/nginx
	Check
		nginx -t

-----------------------------------------------------
SELInux:
-----------------------------------------------------
	https://www.rootusers.com/use-selinux-port-labeling-to-allow-services-to-use-non-standard-ports/
	Allow 8000 in NGINX:
		sudo ausearch -c 'nginx' --raw | audit2allow -M my-nginx
		sudo semodule -X 300 -i my-nginx.pp
	Allow PM2 to start
		sudo ausearch -c 'systemd' --raw | audit2allow -M my-systemd
		sudo semodule -X 300 -i my-systemd.pp

-----------------------------------------------------
Installation
-----------------------------------------------------
	-----------------------------------------------------
	NGINX
	-----------------------------------------------------
		- Info:
			https://fedoraproject.org/wiki/Nginx
		- sudo dnf install nginx | yum install nginx
		- Register:
			sudo systemctl enable nginx.service
			sudo systemctl disable nginx.service
		- Start:
			sudo systemctl start nginx.service
		- Conf:
			/etc/nginx/nginx.conf
		- SELinux : Exec to avoid forward issue:
			setsebool -P httpd_can_network_connect 1

	-----------------------------------------------------
	PM2
	-----------------------------------------------------
		- Info
			http://pm2.keymetrics.io/docs/usage/quick-start/
		- Install
			sudo npm install -g pm2
		- Register as service:
			- pm2 startup
			- sudo env PATH=$PATH:/usr/bin /usr/lib/node_modules/pm2/bin/pm2 startup systemd -u serge --hp /home/serge
			- Create the pm2-evse-env.json
			- pm2 start pm2-evse-env.json
			- pm2 save
		- MISC
			- Service Status:
				systemctl status pm2-serge
				systemctl status pm2-serge.service
			- sudo tail -f /home/serge/.pm2/logs/start-error-0.log
			- sudo tail -f /home/serge/.pm2/logs/start-out-0.log
			- pm2 <stop|restart|delete> <app_name|id|all>
			- pm2 list
			- pm2 info example
			- pm2 monit
			- pm2 logs start

	-----------------------------------------------------
	MongoDB
	-----------------------------------------------------
		- Config
			- sudo gedit /etc/mongod.conf
				- Change the port
				- Set the auth in Security
					authorization: enabled
		- Copy DB
			- In /var/lib/mongo
			- sudo chmod +x * -R
		- Check auth
			- sudo chown -R mongodb:mongodb /var/lib/mongo
			- sudo chown -R mongodb:mongodb /var/log/mongodb
		- sudo service mongod start
		- Enable Startup:
			sudo systemctl enable mongod.service
			sudo /usr/lib/systemd/systemd-sysv-install enable mongod
		- Logs
			- sudo tail -f /var/log/mongodb/mongod.log
		- Service
			- /usr/lib/systemd/system/mongod.service
			- systemctl status mongod.service
			- sudo rm /var/run/mongodb/mongod.pid
		- sudo service mongod stop
		- sudo service mongod restart


-----------------------------------------------------
MISC
-----------------------------------------------------
		- See process
			sudo ps -aux | grep nginx
		- See service logs:
			journalctl -xe
			systemctl  status pm2-serge.service
		find . -name "foo*"
